name: NIDRA Build

on:
  push:
    branches: [ master, development ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master ]

jobs:
  build:
    permissions:
      contents: write
    runs-on: windows-latest
    timeout-minutes: 999
    defaults:
      run:
        shell: powershell

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Cache Python venv
        uses: actions/cache@v4
        id: cache-venv
        with:
          path: venv
          key: ${{ runner.os }}-venv-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-venv-

      - name: Setup Python Environment and Install Dependencies
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: |
          python -m venv venv
          .\venv\Scripts\activate
          python -m pip install --upgrade pip setuptools wheel
          pip install pyinstaller toml
          echo "--- Phase 1: Heavy Binaries ---"
          pip install numpy scipy pandas matplotlib onnxruntime pillow
          echo "--- Phase 2: Medium & Complex Dependencies ---"
          pip install mne sympy
          echo "--- Phase 3: All Remaining Dependencies & Project ---"
          pip install .

      - name: Create script to update version
        if: github.ref == 'refs/heads/development'
        run: |
          @"
          import toml
          import os
          import sys
          pyproject_path = 'pyproject.toml'
          github_run_number = os.environ.get('GITHUB_RUN_NUMBER')
          github_ref = os.environ.get('GITHUB_REF')
          with open(pyproject_path, 'r') as f:
              data = toml.load(f)
          if github_ref == 'refs/heads/development' and github_run_number:
              base_version = str(data['project']['version'])
              if '.dev' in base_version:
                  base_version = base_version.split('.dev')
              new_version = f"{base_version}.dev{github_run_number}"
              data['project']['version'] = new_version
              print(f"Set version to {new_version}", file=sys.stderr)
              with open(pyproject_path, 'w') as f:
                  toml.dump(data, f)
              print("Updated pyproject.toml with dev version", file=sys.stderr)
          "@ | Set-Content -Path update_version.py

      - name: Update version in pyproject.toml
        if: github.ref == 'refs/heads/development'
        run: .\venv\Scripts\python update_version.py
        env:
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_REF: ${{ github.ref }}

      - name: Cache Hugging Face models and data
        uses: actions/cache@v4
        id: cache-hf-data
        with:
          path: |
            NIDRA/models
            examples/test_data_zmax
          key: ${{ runner.os }}-hf-data-v1

      - name: Download Models from Hugging Face
        if: steps.cache-hf-data.outputs.cache-hit != 'true'
        run: |
          New-Item -ItemType Directory -Force -Path NIDRA/models
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/ez6.onnx -OutFile NIDRA/models/ez6.onnx
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/ez6moe.onnx -OutFile NIDRA/models/ez6moe.onnx
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/u-sleep-nsrr-2024.onnx -OutFile NIDRA/models/u-sleep-nsrr-2024.onnx
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/u-sleep-nsrr-2024_eeg.onnx -OutFile NIDRA/models/u-sleep-nsrr-2024_eeg.onnx

      - name: Download Example Data from Hugging Face
        if: steps.cache-hf-data.outputs.cache-hit != 'true'
        run: |
          New-Item -ItemType Directory -Force -Path examples/test_data_zmax
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/EEG_L.edf -OutFile examples/test_data_zmax/EEG_L.edf
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/EEG_R.edf -OutFile examples/test_data_zmax/EEG_R.edf

      - name: Build Executable with PyInstaller
        run: .\venv\Scripts\python -m PyInstaller NIDRA.spec

      - name: Upload Windows Build
        uses: actions/upload-artifact@v4
        with:
          name: NIDRA-windows-build
          path: dist/NIDRA

      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/NIDRA_installer.exe

  test-gui:
    name: Test GUI on multiple platforms
    needs: build
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        use_msvc: [true, false]
        browser: [chromium, firefox, webkit]
        screen:
          - { width: 1920, height: 1080 }
          - { width: 1280, height: 720 }
          - { width: 800, height: 600 }
          - { width: 1024, height: 768 }

    steps:
      - name: Setup MSVC Developer Command Prompt
        if: matrix.use_msvc
        uses: ilammy/msvc-dev-cmd@v1

      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: NIDRA-windows-build
          path: NIDRA

      - name: Set screen resolution
        run: Set-DisplayResolution -Width ${{ matrix.screen.width }} -Height ${{ matrix.screen.height }} -Force

      - name: Install Playwright
        run: python -m pip install --upgrade pip setuptools wheel && pip install playwright && python -m playwright install ${{ matrix.browser }}

      - name: Start app, run demo, take screenshot, and close app
        shell: powershell
        run: |
          Start-Sleep -Seconds 5 # Wait for resolution to settle
          @"
          import subprocess
          import time
          import os
          import sys
          from playwright.sync_api import sync_playwright

          exe_path = os.path.abspath('NIDRA/NIDRA.exe')
          print(f"Looking for exe at {exe_path}")

          if not os.path.exists(exe_path):
              print(f"NIDRA.exe not found at {exe_path}. Exiting.")
              sys.exit(1)

          print(f"Starting application from {exe_path}")
          proc = subprocess.Popen([exe_path])

          print("Waiting for application to launch...")
          time.sleep(10)

          with sync_playwright() as p:
              browser_type = getattr(p, "${{ matrix.browser }}")
              try:
                  browser = browser_type.connect_over_cdp("http://localhost:9222") # Default for many webview apps
                  page = browser.contexts.pages
                  print("Successfully connected to browser")

                  print("Clicking 'Run Demo' button")
                  page.click("#show-example-btn")
                  time.sleep(10) # Wait for demo to run

                  print("Taking screenshot...")
                  screenshot_path = "screenshot.png"
                  page.screenshot(path=screenshot_path)
                  print(f"Screenshot saved to {screenshot_path}")

              except Exception as e:
                  print(f"Could not connect to browser or take screenshot: {e}")
                  # Fallback to desktop screenshot if playwright fails
                  import pyautogui
                  pyautogui.screenshot("screenshot_fallback.png")

          print("Terminating application...")
          proc.terminate()
          try:
              proc.wait(timeout=10)
          except subprocess.TimeoutExpired:
              print("Process did not terminate gracefully, killing.")
              proc.kill()
          print("Application closed.")
          "@ | python -

      - name: Upload screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshot-${{ matrix.os }}-${{ matrix.use_msvc }}-${{ matrix.browser }}-${{ matrix.screen.width }}x${{ matrix.screen.height }}
          path: screenshot.png

  package-screenshots:
    name: Package Screenshots
    needs: test-gui
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download all screenshots
        uses: actions/download-artifact@v4
        with:
          path: screenshots

      - name: Zip screenshots
        run: |
          # The downloaded artifacts are in subdirectories, so we need to find them
          find screenshots -name '*.png' -exec zip screenshots.zip {} +

      - name: Upload screenshots zip
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: screenshots.zip