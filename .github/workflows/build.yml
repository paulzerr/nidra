name: NIDRA Build

on:
  push:
    branches: [ master, development ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master ]

jobs:
  build:
    permissions:
      contents: write
    runs-on: windows-latest
    timeout-minutes: 999
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            ca-certificates
            mingw-w64-x86_64-python
            mingw-w64-x86_64-python-pip
            mingw-w64-x86_64-python-numpy
            mingw-w64-x86_64-python-scipy

      - name: Install 7-Zip
        run: choco install 7zip.install
        shell: powershell

      - name: Setup Python Environment and Install Dependencies
        run: |
          python -m venv --system-site-packages venv
          venv/bin/python -m pip install .
          
      - name: Create script to update version
        if: github.ref == 'refs/heads/development'
        run: |
          cat << 'EOF' > update_version.py
          import toml
          import os
          import sys
          pyproject_path = 'pyproject.toml'
          github_run_number = os.environ.get('GITHUB_RUN_NUMBER')
          github_ref = os.environ.get('GITHUB_REF')
          with open(pyproject_path, 'r') as f:
              data = toml.load(f)
          if github_ref == 'refs/heads/development' and github_run_number:
              base_version = str(data['project']['version'])
              if '.dev' in base_version:
                  base_version = base_version.split('.dev')[0]
              new_version = f"{base_version}.dev{github_run_number}"
              data['project']['version'] = new_version
              print(f"Set version to {new_version}", file=sys.stderr)
              with open(pyproject_path, 'w') as f:
                  toml.dump(data, f)
              print("Updated pyproject.toml with dev version", file=sys.stderr)
          EOF

      - name: Update version in pyproject.toml
        if: github.ref == 'refs/heads/development'
        run: venv/bin/python update_version.py
        env:
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_REF: ${{ github.ref }}

      - name: Download Models from Hugging Face
        run: |
          mkdir -p NIDRA/models
          curl -L https://huggingface.co/pzerr/NIDRA_models/resolve/main/ez6.onnx -o NIDRA/models/ez6.onnx
          curl -L https://huggingface.co/pzerr/NIDRA_models/resolve/main/ez6moe.onnx -o NIDRA/models/ez6moe.onnx
          curl -L https://huggingface.co/pzerr/NIDRA_models/resolve/main/u-sleep-nsrr-2024.onnx -o NIDRA/models/u-sleep-nsrr-2024.onnx
          curl -L https://huggingface.co/pzerr/NIDRA_models/resolve/main/u-sleep-nsrr-2024_eeg.onnx -o NIDRA/models/u-sleep-nsrr-2024_eeg.onnx

      - name: Download Example Data from Hugging Face
        run: |
          mkdir -p examples/test_data_zmax
          curl -L https://huggingface.co/pzerr/NIDRA_models/resolve/main/EEG_L.edf -o examples/test_data_zmax/EEG_L.edf
          curl -L https://huggingface.co/pzerr/NIDRA_models/resolve/main/EEG_R.edf -o examples/test_data_zmax/EEG_R.edf

      - name: Build Executable with PyInstaller
        run: venv/bin/python -m pyinstaller NIDRA.spec

      - name: Bundle VC++ DLLs
        run: |
          find NIDRA/dll -type f ! -name 'ucrtbase.dll' -exec cp {} dist/NIDRA/ \;

      - name: Prepare release structure
        run: |
          mkdir -p NIDRA_app
          mv dist/NIDRA NIDRA_app/
          cat << 'EOF' > launcher.c
          #include <windows.h>
          #include <string.h>
          int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
              char path[MAX_PATH];
              GetModuleFileName(NULL, path, MAX_PATH);
              char *last_slash = strrchr(path, '\\');
              if (last_slash) {
                  *(last_slash + 1) = '\0';
              }
              strcat(path, "NIDRA\\NIDRA.exe");
              ShellExecute(NULL, "open", path, NULL, NULL, SW_SHOWNORMAL);
              return 0;
          }
          EOF
          gcc launcher.c -o NIDRA_app/NIDRA_launcher.exe -mwindows

      - name: Create Self-Extracting Archive
        run: |
          cat << 'EOF' > sfx_config.txt
          ;!@Install@!UTF-8!
          Title="NIDRA Installer"
          BeginPrompt="This will install NIDRA. Do you want to continue?"
          Progress="yes"
          RunProgram="NIDRA_app\\NIDRA_launcher.exe"
          ;!@InstallEnd@!
          EOF
          "/c/Program Files/7-Zip/7z.exe" a NIDRA_archive.7z NIDRA_app
          cat "/c/Program Files/7-Zip/7zS.sfx" sfx_config.txt NIDRA_archive.7z > NIDRA_installer.exe

      - name: Upload Windows Installer
        if: github.ref == 'refs/heads/development'
        uses: actions/upload-artifact@v4
        with:
          name: NIDRA-windows-installer
          path: NIDRA_installer.exe

      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: NIDRA_installer.exe