name: NIDRA Build

on:
  push:
    branches: [ master, development ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master ]

jobs:
  build:
    permissions:
      contents: write
    runs-on: windows-latest
    timeout-minutes: 999
    defaults:
      run:
        shell: powershell

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install 7-Zip
        run: choco install 7zip.install

      - name: Setup Python Environment and Install Dependencies
        run: |
          python -m venv venv
          .\venv\Scripts\activate
          python -m pip install --upgrade pip setuptools wheel
          pip install pyinstaller toml
          echo "--- Phase 1: Heavy Binaries ---"
          pip install numpy scipy pandas matplotlib onnxruntime pillow
          echo "--- Phase 2: Medium & Complex Dependencies ---"
          pip install mne sympy
          echo "--- Phase 3: All Remaining Dependencies & Project ---"
          pip install .

      - name: Create script to update version
        if: github.ref == 'refs/heads/development'
        run: |
          @"
          import toml
          import os
          import sys
          pyproject_path = 'pyproject.toml'
          github_run_number = os.environ.get('GITHUB_RUN_NUMBER')
          github_ref = os.environ.get('GITHUB_REF')
          with open(pyproject_path, 'r') as f:
              data = toml.load(f)
          if github_ref == 'refs/heads/development' and github_run_number:
              base_version = str(data['project']['version'])
              if '.dev' in base_version:
                  base_version = base_version.split('.dev')[0]
              new_version = f"{base_version}.dev{github_run_number}"
              data['project']['version'] = new_version
              print(f"Set version to {new_version}", file=sys.stderr)
              with open(pyproject_path, 'w') as f:
                  toml.dump(data, f)
              print("Updated pyproject.toml with dev version", file=sys.stderr)
          "@ | Set-Content -Path update_version.py

      - name: Update version in pyproject.toml
        if: github.ref == 'refs/heads/development'
        run: .\venv\Scripts\python update_version.py
        env:
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_REF: ${{ github.ref }}

      - name: Download Models from Hugging Face
        run: |
          New-Item -ItemType Directory -Force -Path NIDRA/models
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/ez6.onnx -OutFile NIDRA/models/ez6.onnx
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/ez6moe.onnx -OutFile NIDRA/models/ez6moe.onnx
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/u-sleep-nsrr-2024.onnx -OutFile NIDRA/models/u-sleep-nsrr-2024.onnx
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/u-sleep-nsrr-2024_eeg.onnx -OutFile NIDRA/models/u-sleep-nsrr-2024_eeg.onnx

      - name: Download Example Data from Hugging Face
        run: |
          New-Item -ItemType Directory -Force -Path examples/test_data_zmax
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/EEG_L.edf -OutFile examples/test_data_zmax/EEG_L.edf
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/EEG_R.edf -OutFile examples/test_data_zmax/EEG_R.edf

      - name: Build Executable with PyInstaller
        run: .\venv\Scripts\python -m PyInstaller NIDRA.spec

      - name: Show dist directory contents
        run: |
          if (Test-Path -Path dist) {
            Get-ChildItem -Path dist -Recurse
          } else {
            Write-Host "dist directory not found."
          }

      - name: Setup MSVC Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1

      - name: Prepare release structure
        run: |
          New-Item -ItemType Directory -Force -Path NIDRA_app
          $buildDir = (Get-ChildItem -Path dist -Directory).Name
          Move-Item -Path "dist\$buildDir" -Destination "NIDRA_app\NIDRA"
          @"
          #include <windows.h>
          #include <string.h>
          int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
              char path[MAX_PATH];
              GetModuleFileName(NULL, path, MAX_PATH);
              char *last_slash = strrchr(path, '\\');
              if (last_slash) {
                  *(last_slash + 1) = '\0';
              }
              strcat(path, "NIDRA_app\\NIDRA\\NIDRA.exe");
              ShellExecute(NULL, "open", path, NULL, NULL, SW_SHOWNORMAL);
              return 0;
          }
          "@ | Set-Content -Path launcher.c
          cl.exe launcher.c /Fe:NIDRA_launcher.exe /link /SUBSystem:windows Shell32.lib

      - name: Create Self-Extracting Archive
        run: |
          @"
          ;!@Install@!UTF-8!
          Title="NIDRA Installer"
          BeginPrompt="This will install NIDRA. Do you want to continue?"
          Progress="yes"
          RunProgram="NIDRA_launcher.exe"
          ;!@InstallEnd@!
          "@ | Set-Content -Path sfx_config.txt
          & "C:\Program Files\7-Zip\7z.exe" a NIDRA_archive.7z NIDRA_app NIDRA_launcher.exe
          cmd.exe --% /c copy /b "C:\Program Files\7-Zip\7zS.sfx" + sfx_config.txt + NIDRA_archive.7z NIDRA_installer.exe

      - name: Upload Windows Installer
        if: github.ref == 'refs/heads/development'
        uses: actions/upload-artifact@v4
        with:
          name: NIDRA-windows-installer
          path: NIDRA_installer.exe

      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: NIDRA_installer.exe