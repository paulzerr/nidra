name: NIDRA Build

on:
  push:
    branches: [ master, development ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master ]

jobs:
  build:
    permissions:
      contents: write
    runs-on: windows-latest
    timeout-minutes: 999
    defaults:
      run:
        shell: powershell

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Cache Python venv
        uses: actions/cache@v4
        id: cache-venv
        with:
          path: venv
          key: ${{ runner.os }}-venv-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-venv-

      - name: Setup Python Environment and Install Dependencies
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: |
          python -m venv venv
          .\venv\Scripts\activate
          python -m pip install --upgrade pip setuptools wheel
          pip install pyinstaller toml
          echo "--- Phase 1: Heavy Binaries ---"
          pip install numpy scipy pandas matplotlib onnxruntime pillow
          echo "--- Phase 2: Medium & Complex Dependencies ---"
          pip install mne sympy
          echo "--- Phase 3: All Remaining Dependencies & Project ---"
          pip install .

      - name: Create script to update version
        if: github.ref == 'refs/heads/development'
        run: |
          @"
          import toml
          import os
          import sys
          pyproject_path = 'pyproject.toml'
          github_run_number = os.environ.get('GITHUB_RUN_NUMBER')
          github_ref = os.environ.get('GITHUB_REF')
          with open(pyproject_path, 'r') as f:
              data = toml.load(f)
          if github_ref == 'refs/heads/development' and github_run_number:
              base_version = str(data['project']['version'])
              if '.dev' in base_version:
                  base_version = base_version.split('.dev')
              new_version = f"{base_version}.dev{github_run_number}"
              data['project']['version'] = new_version
              print(f"Set version to {new_version}", file=sys.stderr)
              with open(pyproject_path, 'w') as f:
                  toml.dump(data, f)
              print("Updated pyproject.toml with dev version", file=sys.stderr)
          "@ | Set-Content -Path update_version.py

      - name: Update version in pyproject.toml
        if: github.ref == 'refs/heads/development'
        run: .\venv\Scripts\python update_version.py
        env:
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_REF: ${{ github.ref }}

      - name: Cache Hugging Face models and data
        uses: actions/cache@v4
        id: cache-hf-data
        with:
          path: |
            NIDRA/models
            examples/test_data_zmax
          key: ${{ runner.os }}-hf-data-v1

      - name: Download Models from Hugging Face
        if: steps.cache-hf-data.outputs.cache-hit != 'true'
        run: |
          New-Item -ItemType Directory -Force -Path NIDRA/models
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/ez6.onnx -OutFile NIDRA/models/ez6.onnx
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/ez6moe.onnx -OutFile NIDRA/models/ez6moe.onnx
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/u-sleep-nsrr-2024.onnx -OutFile NIDRA/models/u-sleep-nsrr-2024.onnx
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/u-sleep-nsrr-2024_eeg.onnx -OutFile NIDRA/models/u-sleep-nsrr-2024_eeg.onnx

      - name: Download Example Data from Hugging Face
        if: steps.cache-hf-data.outputs.cache-hit != 'true'
        run: |
          New-Item -ItemType Directory -Force -Path examples/test_data_zmax
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/EEG_L.edf -OutFile examples/test_data_zmax/EEG_L.edf
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/EEG_R.edf -OutFile examples/test_data_zmax/EEG_R.edf

      - name: Build Executable with PyInstaller
        run: .\venv\Scripts\python -m PyInstaller NIDRA.spec

      - name: Setup MSVC Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1



      - name: Create Self-Extracting Archive
        run: |
          @"
          ;!@Install@!UTF-8!
          Title="NIDRA Installer"
          BeginPrompt="This will install NIDRA. Do you want to continue?"
          Progress="yes"
          FinishMessage="Do you want to launch NIDRA now?"
          RunProgram="NIDRA\NIDRA.exe"
          ;!@InstallEnd@!
          "@ | Set-Content -Path sfx_config.txt
          Set-Location -Path dist
          & "C:\Program Files\7-Zip\7z.exe" a ..\NIDRA_archive.7z NIDRA
          Set-Location -Path ..
          cmd.exe --% /c copy /b "C:\Program Files\7-Zip\7z.sfx" + sfx_config.txt + NIDRA_archive.7z NIDRA_installer.exe

      - name: Upload Windows Installer
        if: github.ref == 'refs/heads/development'
        uses: actions/upload-artifact@v4
        with:
          name: NIDRA-windows-installer
          path: NIDRA_installer.exe

      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: NIDRA_installer.exe

  test-gui:
    name: Test GUI on multiple platforms
    needs: build
    # This job tests the application's GUI on different versions of Windows and at different screen resolutions.
    # It installs the application from the build artifact, sets the screen resolution, launches the app,
    # and takes a screenshot of the desktop.
    # Note: The user mentioned testing on different browsers. Since this is a desktop application using a
    # system webview (via Neutralino), it's not possible to run it in different browsers like Chrome or Firefox.
    # The test will run against the default system webview on the runner (Edge/Chromium-based).
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-2019, windows-2022]
        screen:
          - { width: 1920, height: 1080 }
          - { width: 1280, height: 720 }
          - { width: 800, height: 600 }
          - { width: 1024, height: 768 }

    steps:
      - name: Download installer
        uses: actions/download-artifact@v4
        with:
          name: NIDRA-windows-installer
          path: .

      - name: Install application
        run: Start-Process -FilePath "NIDRA_installer.exe" -ArgumentList "/S" -Wait

      - name: Set screen resolution
        run: Set-DisplayResolution -Width ${{ matrix.screen.width }} -Height ${{ matrix.screen.height }} -Force

      - name: Install screenshot dependencies
        run: python -m pip install --upgrade pip setuptools wheel && pip install pyautogui pillow

      - name: Start app, take screenshot, and close app
        shell: powershell
        run: |
          Start-Sleep -Seconds 5 # Wait for resolution to settle
          @"
          import subprocess
          import time
          import pyautogui
          import os
          import sys

          print(f"Current screen size: {pyautogui.size()}")

          # The installer should extract to a 'NIDRA' folder in the current directory.
          exe_path = os.path.abspath('NIDRA/NIDRA.exe')
          print(f"Looking for exe at {exe_path}")

          if not os.path.exists(exe_path):
              print(f"NIDRA.exe not found at {exe_path}. Exiting.")
              sys.exit(1)

          print(f"Starting application from {exe_path}")
          proc = subprocess.Popen([exe_path])

          print("Waiting for application to launch...")
          time.sleep(20)

          print("Taking screenshot...")
          screenshot = pyautogui.screenshot()
          screenshot_path = "screenshot.png"
          screenshot.save(screenshot_path)
          print(f"Screenshot saved to {screenshot_path}")

          print("Terminating application...")
          proc.terminate()
          try:
              proc.wait(timeout=10)
          except subprocess.TimeoutExpired:
              print("Process did not terminate gracefully, killing.")
              proc.kill()
          print("Application closed.")
          "@ | python -

      - name: Upload screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshot-${{ matrix.os }}-${{ matrix.screen.width }}x${{ matrix.screen.height }}
          path: screenshot.png