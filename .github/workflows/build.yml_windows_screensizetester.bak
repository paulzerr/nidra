name: NIDRA Build

on:
  push:
    branches: [ master, development ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master ]

jobs:
  build:
    permissions:
      contents: write
    runs-on: windows-latest
    timeout-minutes: 999
    defaults:
      run:
        shell: powershell

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Cache Python venv
        uses: actions/cache@v4
        id: cache-venv
        with:
          path: venv
          key: ${{ runner.os }}-venv-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-venv-

      - name: Setup Python Environment and Install Dependencies
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: |
          python -m venv venv
          .\venv\Scripts\activate
          python -m pip install --upgrade pip setuptools wheel
          pip install pyinstaller toml
          echo "--- Phase 1: Heavy Binaries ---"
          pip install numpy scipy pandas matplotlib onnxruntime pillow
          echo "--- Phase 2: Medium & Complex Dependencies ---"
          pip install mne sympy
          echo "--- Phase 3: All Remaining Dependencies & Project ---"
          pip install .

      - name: Create script to update version
        if: github.ref == 'refs/heads/development'
        run: |
          @"
          import toml
          import os
          import sys
          pyproject_path = 'pyproject.toml'
          github_run_number = os.environ.get('GITHUB_RUN_NUMBER')
          github_ref = os.environ.get('GITHUB_REF')
          with open(pyproject_path, 'r') as f:
              data = toml.load(f)
          if github_ref == 'refs/heads/development' and github_run_number:
              base_version = str(data['project']['version'])
              if '.dev' in base_version:
                  base_version = base_version.split('.dev')[0]
              new_version = f"{base_version}.dev{github_run_number}"
              data['project']['version'] = new_version
              print(f"Set version to {new_version}", file=sys.stderr)
              with open(pyproject_path, 'w') as f:
                  toml.dump(data, f)
              print("Updated pyproject.toml with dev version", file=sys.stderr)
          "@ | Set-Content -Path update_version.py

      - name: Update version in pyproject.toml
        if: github.ref == 'refs/heads/development'
        run: .\venv\Scripts\python update_version.py
        env:
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_REF: ${{ github.ref }}

      - name: Cache Hugging Face models and data
        uses: actions/cache@v4
        id: cache-hf-data
        with:
          path: |
            NIDRA/models
            examples/test_data_zmax
          key: ${{ runner.os }}-hf-data-v1

      - name: Download Models from Hugging Face
        if: steps.cache-hf-data.outputs.cache-hit != 'true'
        run: |
          New-Item -ItemType Directory -Force -Path NIDRA/models
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/ez6.onnx -OutFile NIDRA/models/ez6.onnx
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/ez6moe.onnx -OutFile NIDRA/models/ez6moe.onnx
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/u-sleep-nsrr-2024.onnx -OutFile NIDRA/models/u-sleep-nsrr-2024.onnx
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/u-sleep-nsrr-2024_eeg.onnx -OutFile NIDRA/models/u-sleep-nsrr-2024_eeg.onnx

      - name: Download Example Data from Hugging Face
        if: steps.cache-hf-data.outputs.cache-hit != 'true'
        run: |
          New-Item -ItemType Directory -Force -Path examples/test_data_zmax
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/EEG_L.edf -OutFile examples/test_data_zmax/EEG_L.edf
          Invoke-WebRequest -Uri https://huggingface.co/pzerr/NIDRA_models/resolve/main/EEG_R.edf -OutFile examples/test_data_zmax/EEG_R.edf

      - name: Build Executable with PyInstaller
        run: .\venv\Scripts\python -m PyInstaller NIDRA.spec

      - name: Upload Windows Build
        uses: actions/upload-artifact@v4
        with:
          name: NIDRA-windows-build
          path: dist/NIDRA

      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/NIDRA_installer.exe

  test-gui:
    name: Test GUI on multiple platforms
    needs: build
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        use_msvc: [true, false]
        browser: [chromium, msedge, firefox, webkit]
        screen:
          - { width: 3840, height: 2160 }  # 4K
          - { width: 2560, height: 1440 }  # 2K
          - { width: 1920, height: 1080 }  # Full HD
          - { width: 1280, height: 720 }   # HD
          - { width: 800, height: 600 }    # Small

    steps:
      - name: Disable Edge First-Run Experience
        run: |
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Edge" /v "HideFirstRunExperience" /t REG_DWORD /d 1 /f
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Edge" /v "NewTabPageLocation" /t REG_SZ /d "https://www.blank.org/" /f

      - name: Setup MSVC Developer Command Prompt
        if: matrix.use_msvc
        uses: ilammy/msvc-dev-cmd@v1

      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: NIDRA-windows-build
          path: NIDRA

      - name: Set screen resolution
        run: Set-DisplayResolution -Width ${{ matrix.screen.width }} -Height ${{ matrix.screen.height }} -Force

      - name: Install Test Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install playwright requests
          python -m playwright install chromium firefox webkit

      - name: Start app, run demo, take screenshot, and close app
        shell: powershell
        run: |
          Start-Sleep -Seconds 5
          @"
          import subprocess
          import time
          import os
          import sys
          import requests
          from playwright.sync_api import sync_playwright

          env = os.environ.copy()
          env['BROWSER'] = 'echo'

          exe_path = os.path.abspath('NIDRA/NIDRA.exe')
          print(f"Looking for exe at {exe_path}")

          if not os.path.exists(exe_path):
              print(f"NIDRA.exe not found at {exe_path}. Exiting.")
              sys.exit(1)

          print(f"Starting application from {exe_path}")
          proc = subprocess.Popen([exe_path], env=env, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)

          base_url = "http://127.0.0.1"
          ports_to_try = [5001, 5002]
          app_url = None
          print("Searching for running server...")
          for i in range(20):
              for port in ports_to_try:
                  url = f"{base_url}:{port}"
                  try:
                      response = requests.get(url, timeout=0.5)
                      if response.status_code == 200:
                          print(f"Server is up and running on {url}")
                          app_url = url
                          break
                  except requests.ConnectionError:
                      continue
              if app_url:
                  break
              print(f"Still waiting for server... ({i+1}/20)")
              time.sleep(1)

          if not app_url:
              print("Could not connect to the Flask server on any expected port.")
              proc.kill()
              stdout, stderr = proc.communicate()
              print("--- STDOUT ---")
              print(stdout)
              print("--- STDERR ---")
              print(stderr)
              sys.exit(1)

          try:
              with sync_playwright() as p:
                  browser_name = "${{ matrix.browser }}"
                  if browser_name == "msedge":
                      print("Launching Microsoft Edge via Playwright (Chromium channel=msedge)...")
                      browser = p.chromium.launch(channel="msedge")
                  else:
                      print(f"Launching {browser_name}...")
                      browser = getattr(p, browser_name).launch()

                  page = browser.new_page()
                  print(f"Navigating to {app_url}")
                  page.goto(app_url)
                  print("Successfully loaded page.")

                  print("Clicking 'Run Demo' button")
                  page.click("#show-example-btn")
                  time.sleep(10)

                  print("Taking screenshot...")
                  screenshot_name = f"screenshot-${{ matrix.browser }}-${{ matrix.use_msvc }}-${{ matrix.screen.width }}x${{ matrix.screen.height }}.png"
                  page.screenshot(path=screenshot_name, full_page=True)
                  print(f"Screenshot saved to {screenshot_name}")
                  browser.close()
          finally:
              print("Terminating application...")
              proc.terminate()
              try:
                  proc.wait(timeout=10)
              except subprocess.TimeoutExpired:
                  print("Process did not terminate gracefully, killing.")
                  proc.kill()
              print("Application closed.")
          "@ | python -

      - name: Upload screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshot-${{ matrix.browser }}-${{ matrix.use_msvc }}-${{ matrix.screen.width }}x${{ matrix.screen.height }}
          path: screenshot-${{ matrix.browser }}-${{ matrix.use_msvc }}-${{ matrix.screen.width }}x${{ matrix.screen.height }}.png

  package-screenshots:
    name: Package Screenshots
    needs: test-gui
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download all screenshots
        uses: actions/download-artifact@v4
        with:
          path: screenshots
          pattern: screenshot-*
          merge-multiple: true


      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: screenshots/*
